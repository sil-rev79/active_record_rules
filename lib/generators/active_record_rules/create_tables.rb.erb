# -*- ruby -*-
class CreateActiveRecordRulesTables < ActiveRecord::Migration<%= migration_version %>
  def change
    create_table :arr__rule_matches, id: :bigint do |t|
      t.integer :rule_id, null: false, limit: 4
      t.timestamp :queued_since
      t.timestamp :running_since
      t.timestamp :failed_since
      t.<%= json_type %> :ids, null: false
      t.<%= json_type %> :live_arguments
      t.<%= json_type %> :next_arguments
      <%- if postgres? -%>
      t.index [:ids], using: :gin, opclass: :jsonb_path_ops, name: 'rule_match_ids_lookup'
      <%- end -%>
      t.index [:rule_id, :ids], unique: true, name: 'rule_match_uniqueness'
      t.index [:rule_id, :queued_since], name: 'rule_match_queued_since'
      t.index [:rule_id, :running_since], name: 'rule_match_running_since'
      t.index [:rule_id, :failed_since], name: 'rule_match_failed_since'
    end
  end
end
