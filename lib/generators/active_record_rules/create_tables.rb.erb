# -*- ruby -*-
class CreateActiveRecordRulesTables < ActiveRecord::Migration<%= migration_version %>
  def change
    create_table :arr__rule_matches, id: :bigint do |t|
      t.integer :rule_id, null: false, limit: 4
      t.integer :awaiting_execution, null: false
      t.<%= json_type %> :ids
      t.<%= json_type %> :live_arguments
      t.<%= json_type %> :next_arguments
      <%- if postgres? %>
      t.index [:ids], using: :gin, opclass: :jsonb_path_ops, name: 'rule_match_ids_lookup'
      <%- end %>
      t.index [:rule_id, :ids], unique: true, name: 'rule_match_uniqueness'
      t.index [:rule_id, :awaiting_execution], name: 'rule_match_awaiting_execution'
    end
  end
end
