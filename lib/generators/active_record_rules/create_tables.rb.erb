# -*- ruby -*-
class CreateActiveRecordRulesTables < ActiveRecord::Migration<%= migration_version %>
  def change
    <%- if postgres? %>
    enable_extension :btree_gin # This is needed to include rule_id in the GIN index, below
    <%- end %>

    create_table :arr__rules do |t|
      t.string :name, null: false
      t.string :definition, null: false
    end

    create_table :arr__rule_matches do |t|
      t.references :rule, foreign_key: { to_table: :arr__rules }, null: false
      t.integer :awaiting_execution, null: false
      t.<%= json_type %> :ids
      t.<%= json_type %> :live_arguments
      t.<%= json_type %> :next_arguments
      t.index [:rule_id, :ids], unique: true, name: 'rule_match_uniqueness'
      <%- if postgres? %>
      t.index [:rule_id, :ids], using: :gin, name: 'rule_match_ids_lookup'
      <%- end %>
      t.index [:rule_id, :awaiting_execution], name: 'rule_match_awaiting_execution'
    end
  end
end
